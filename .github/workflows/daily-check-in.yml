name: Daily Check-in

on:
  schedule:
    - cron: '0 */4 * * *'  # æ¯ 3 å°æ—¶è§¦å‘ä¸€æ¬¡ï¼ˆUTCï¼‰
  workflow_dispatch:

jobs:
  run_script:
    runs-on: ubuntu-22.04
    environment: LINUXDO

    steps:
      - name: Random delay (0â€“1 hour)
        shell: bash
        run: |
          s=$(( RANDOM % 3600 ))
          echo "Random sleep: $s seconds"
          sleep $s

      - uses: actions/checkout@v4

      # å®‰è£…çœŸå® Chrome
      - uses: browser-actions/setup-chrome@v1

      - name: Check Chrome version
        run: |
          which google-chrome || true
          google-chrome --version || true

      # å®‰è£… Xvfb
      - name: Install Xvfb
        run: |
          sudo apt-get update
          sudo apt-get install -y xvfb

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9.19'
          cache: 'pip'
          cache-dependency-path: requirements.txt

      - name: Install python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # âœ… Xvfb + HEADLESS=falseï¼ˆéæ— å¤´ï¼‰
      - name: Execute script (Xvfb + non-headless)
        env:
          LINUXDO_USERNAME: ${{ secrets.LINUXDO_USERNAME }}
          LINUXDO_PASSWORD: ${{ secrets.LINUXDO_PASSWORD }}
          USERNAME: ${{ secrets.USERNAME }}
          PASSWORD: ${{ secrets.PASSWORD }}

          GOTIFY_URL: ${{ secrets.GOTIFY_URL }}
          GOTIFY_TOKEN: ${{ secrets.GOTIFY_TOKEN }}
          SC3_PUSH_KEY: ${{ secrets.SC3_PUSH_KEY }}
          WXPUSH_URL: ${{ secrets.WXPUSH_URL }}
          WXPUSH_TOKEN: ${{ secrets.WXPUSH_TOKEN }}

          BROWSE_ENABLED: "true"

          # âœ… å¼ºåˆ¶é headless
          HEADLESS: "false"

          # âœ… æ˜ç¡® Chrome è·¯å¾„ï¼ˆå¾ˆé‡è¦ï¼‰
          CHROME_PATH: "/usr/bin/google-chrome"

          # å¯é€‰ï¼šå‚æ•°å¾®è°ƒ
          # MIN_READ_STAY: "5"
          # READ_STATE_TIMEOUT: "20"
        run: |
          xvfb-run -a --server-args="-screen 0 1920x1080x24 -ac +extension RANDR" python main.py

      - name: Send Telegram Success Notification
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_USERID: ${{ secrets.TELEGRAM_USERID }}
          LINUXDO_USERNAME: ${{ secrets.LINUXDO_USERNAME }}
        if: ${{ success() && env.TELEGRAM_TOKEN != '' && env.TELEGRAM_USERID != '' }}
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ env.TELEGRAM_TOKEN }}/sendMessage" \
          -d chat_id=${{ env.TELEGRAM_USERID }} \
          -d parse_mode=HTML \
          -d text="âœ… <b>LINUX DO</b>\nğŸ‘¤ ç”¨æˆ·ï¼š<code>${{ env.LINUXDO_USERNAME }}</code>\nğŸ‰ æ¯æ—¥ç­¾åˆ°æˆåŠŸå®Œæˆ"

      - name: Send Telegram Failure Notification
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_USERID: ${{ secrets.TELEGRAM_USERID }}
          LINUXDO_USERNAME: ${{ secrets.LINUXDO_USERNAME }}
        if: ${{ failure() && env.TELEGRAM_TOKEN != '' && env.TELEGRAM_USERID != '' }}
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ env.TELEGRAM_TOKEN }}/sendMessage" \
          -d chat_id=${{ env.TELEGRAM_USERID }} \
          -d parse_mode=HTML \
          -d text="âŒ <b>LINUX DO</b>\nğŸ‘¤ ç”¨æˆ·ï¼š<code>${{ env.LINUXDO_USERNAME }}</code>\nâš ï¸ æ¯æ—¥ç­¾åˆ°å¤±è´¥ï¼Œè¯·æŸ¥çœ‹ Actions æ—¥å¿—"

      - name: Delete workflow runs
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ github.token }}
          repository: ${{ github.repository }}
          retain_days: 10
          keep_minimum_runs: 6
